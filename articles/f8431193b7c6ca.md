---
title: "ãƒ™ãƒ³ãƒ€ãƒ¼ãƒ­ãƒƒã‚¯ã‚¤ãƒ³ã—ãªã„CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã€Daggerã‚’ä½¿ã£ã¦CodeCheckã‚’è‡ªå‹•åŒ–ã—ã¦ã¿ãŸã€‚"
emoji: "ğŸ—¡ï¸"
type: "tech"
topics: ["docker", "javascript", "cue", "buildkit"]
published: true
---

# Dagger ã¨ã¯
https://dagger.io
https://docs.dagger.io/1235/what

å…¬å¼ã«ã‚ˆã‚‹ã¨
> PORTABLE DEVKIT FOR CI/CD PIPELINES.
> Build powerful CI/CD pipelines quickly, then run them anywhere.

ã¨ã®ã“ã¨ã§ã™ã€‚
ç‰¹å¾´ã¨ã—ã¦ã¯

- YAMLã§ã¯ãªãã€ŒCUEè¨€èªã€ã¨ã„ã†ã‚‚ã®ã§è¨˜è¿°ã™ã‚‹
	- importæ§‹æ–‡ãŒã‚ã‚‹ã®ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å†åˆ©ç”¨æ€§ãŒé«˜ã¾ã‚‹
- Docker, BuildkitãŒå‹•ä½œã™ã‚‹ç’°å¢ƒã§ã‚ã‚Œã°ã©ã“ã§ã‚‚å‹•ä½œã™ã‚‹
	- ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚‚å®Ÿè¡Œã§ãã‚‹ãŸã‚ã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®é–‹ç™ºãƒ»å‹•ä½œç¢ºèªãŒå®¹æ˜“

ãŒã‚ã‚Šã¾ã™ã€‚

# ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«
ã“ã¡ã‚‰ã®æ‰‹é †ã«å¾“ã†ã“ã¨ã§ã€å…¬å¼ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã§ãã¾ã™ã€‚
ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªTodoã‚¢ãƒ—ãƒªã§ã™ï¼‰
https://docs.dagger.io/1200/local-dev


# æ§‹æ–‡
ä¸Šè¨˜ã®Todoã‚¢ãƒ—ãƒªã§å®Ÿè¡Œã•ã‚Œã‚‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«ã¤ã„ã¦æŠœç²‹ã—ãŸã‚‚ã®ã§è§£èª¬ã—ã¾ã™ã€‚

```go:todoapp.cue(æŠœç²‹)
package todoapp

// å¿…è¦ã«ãªã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ãƒ•ã‚¡ã‚¤ãƒ«å…ˆé ­ã«ã¦ã“ã®ã‚ˆã†ã«importã—ã¾ã™
// Goè¨€èªã¿ãŸã„ã§ã™ã­
import (
	"dagger.io/dagger"
	"dagger.io/dagger/core"
	"universe.dagger.io/alpine"
	"universe.dagger.io/bash"
	"universe.dagger.io/docker"
	"universe.dagger.io/netlify"
)

// ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å‹•ä½œã¯ã™ã¹ã¦ dagger.#Plan å†…ã«è¨˜è¿°ã—ã¦ã„ãã¾ã™
dagger.#Plan & {
	// client: ã§ã¯å‹•ä½œã•ã›ã‚‹ç’°å¢ƒã«é–¢ã‚ã‚‹è¨­å®šã‚’è¨˜è¿°ã™ã‚‹ã—ã¾ã™
	// - DaggerãŒå®Ÿè¡Œã•ã‚Œã‚‹ãƒ›ã‚¹ãƒˆã¨ã®å…¥å‡ºåŠ›è¨­å®š
	// - ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
	client: {
		filesystem: {
			"./": read: {
				contents: dagger.#FS
				exclude: [
					"README.md",
					"_build",
					"todoapp.cue",
					"node_modules",
				]
			}
			"./_build": write: contents: actions.build.contents.output
		}
		env: {
			APP_NAME:      string
			NETLIFY_TEAM:  string
			NETLIFY_TOKEN: dagger.#Secret
		}
	}
	// actions: ã«ã¯dagger-cliã‹ã‚‰å‘¼ã³å‡ºã›ã‚‹ã‚³ãƒãƒ³ãƒ‰ç¾¤ãŒè¨˜è¿°ã•ã‚Œã¾ã™
	// ä»–ã®actionã«å¯¾ã™ã‚‹å‚ç…§ãŒè¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ã¨ã€é †ã«å®Ÿè¡Œã•ã‚Œã‚‹
	// ($ dagger do build ã™ã‚‹ã¨ deps->test->build ã¨å®Ÿè¡Œã•ã‚Œã‚‹)
	actions: {
		deps: docker.#Build & {
			steps: [
				// ~~~ä¸­ç•¥~~~
			]
		}

		test: bash.#Run & {
			input:   deps.output
			workdir: "/src"
			mounts:  _nodeModulesMount
			script: contents: #"""
				yarn run test
				"""#
		}

		build: {
			run: bash.#Run & {
				input:   test.output
				mounts:  _nodeModulesMount
				workdir: "/src"
				script: contents: #"""
					yarn run build
					"""#
			}

			contents: core.#Subdir & {
				input: run.output.rootfs
				path:  "/src/build"
			}
		}
	}
}
```

# CodeCheckã‚’å®Ÿè£…ã—ã¦ã¿ãŸ
ä»Šå›ã¯typescriptã®CodeCheckã‚’Daggerã§å®Ÿè£…ã—ã¦ã¿ã¾ã—ãŸã€‚

:::details ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
```go:codecheck.cue
package codecheck

import (
	"dagger.io/dagger"
	"dagger.io/dagger/core"
	"universe.dagger.io/bash"
	"universe.dagger.io/docker"
)

dagger.#Plan & {
	_backendModulesMount: "/src/node_modules": {
		dest:     "/src/node_modules"
		type:     "cache"
		contents: core.#CacheDir & {
			id: "backend-modules-cache"
		}

	}
	_frontendModulesMount: "/src/node_modules": {
		dest:     "/src/node_modules"
		type:     "cache"
		contents: core.#CacheDir & {
			id: "frontend-modules-cache"
		}

	}
	client: {
		filesystem: {
			"./backend": read: {
				contents: dagger.#FS
				exclude: [
					"README.md",
					"dist",
					"node_modules",
				]
			}
			"./frontend": read: {
				contents: dagger.#FS
				exclude: [
					"README.md",
					"nginx.conf",
					"node_modules",
				]
			}
		}
	}
	actions: {
		backendDeps: docker.#Build & {
			steps: [
				docker.#Pull & {source: "node:lts-buster"},
				docker.#Copy & {
					contents: client.filesystem."./backend".read.contents
					dest:     "/app"
				},
				bash.#Run & {
					workdir: "/app"
					mounts:  _backendModulesMount
					script: contents: #"""
						yarn
						yarn run prisma:generate
						"""#
				},
			]
		}
		frontendDeps: docker.#Build & {
			steps: [
				docker.#Pull & {source: "node:lts-buster"},
				docker.#Copy & {
					contents: client.filesystem."./frontend".read.contents
					dest:     "/app"
				},
				bash.#Run & {
					workdir: "/app"
					mounts:  _frontendModulesMount
					script: contents: "yarn"
				},
			]
		}
		codecheck: {
			backend: {
				typeCheck: bash.#Run & {
					input:   backendDeps.output
					workdir: "/app"
					mounts:  _backendModulesMount
					script: contents: "yarn type-check"
				}
				lint: bash.#Run & {
					input:   backendDeps.output
					workdir: "/app"
					mounts:  _backendModulesMount
					script: contents: "yarn lint"
				}
				format: bash.#Run & {
					input:   backendDeps.output
					workdir: "/app"
					mounts:  _backendModulesMount
					script: contents: "yarn format"
				}
			}
			frontend: {
				typeCheck: bash.#Run & {
					input:   frontendDeps.output
					workdir: "/app"
					mounts:  _frontendModulesMount
					script: contents: "yarn type-check"
				}
				lint: bash.#Run & {
					input:   frontendDeps.output
					workdir: "/app"
					mounts:  _frontendModulesMount
					script: contents: "yarn lint"
				}
				format: bash.#Run & {
					input:   frontendDeps.output
					workdir: "/app"
					mounts:  _frontendModulesMount
					script: contents: "yarn format"
				}
			}
		}
	}
}
```
:::

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
backend(Fastify) + frontend(React)ã¨ã„ã†æ§‹æˆã®ãƒªãƒã‚¸ãƒˆãƒªã«å¯¾ã—ã¦å®Ÿè£…ã—ã¾ã—ãŸã€‚
```
repository
â”œâ”€â”€ .github
â”‚   â””â”€â”€ workflows
â”‚       â””â”€â”€ codecheck.yml
â”œâ”€â”€ backend
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ src
â”‚   â”œâ”€â”€ yarn-error.log
â”‚   â””â”€â”€ yarn.lock
â”œâ”€â”€ cue.mod
â”‚   â”œâ”€â”€ module.cue
â”‚   â”œâ”€â”€ pkg
â”‚   â””â”€â”€ usr
â”œâ”€â”€ dagger
â”‚   â””â”€â”€ codecheck.cue
â””â”€â”€ frontend
    â”œâ”€â”€ Dockerfile
    â”œâ”€â”€ package.json
    â”œâ”€â”€ src
    â””â”€â”€ yarn.lock
```

## ä¾å­˜é–¢ä¿‚ã‚’è§£æ±º
`dagger.#Plan: actions: frontend/backendDeps` ã«ã¦ã€ãã‚Œãã‚Œã®ä¾å­˜é–¢ä¿‚ã‚’è§£æ±ºã—ã¦ã„ã¾ã™ã€‚
ä»Šå›ã®æ§‹æˆã§ã¯ã©ã¡ã‚‰ã‚‚Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã„ã¾ã™ãŒã€ä¾‹ãˆã°backendãŒpythonã ã£ãŸã¨ã—ã¦ã‚‚åŒã˜ã‚ˆã†ãªè¨˜è¿°ãŒã§ãã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

```go:codecheck.cue
backendDeps: docker.#Build & {
	steps: [
		docker.#Pull & {source: "node:lts-buster"},
		docker.#Copy & {
			contents: client.filesystem."./backend".read.contents
			dest:     "/app"
		},
		bash.#Run & {
			workdir: "/app"
			mounts:  _backendModulesMount
			script: contents: #"""
				yarn
				yarn run prisma:generate
				"""#
		},
	]
}
frontendDeps: docker.#Build & {
	steps: [
		docker.#Pull & {source: "node:lts-buster"},
		docker.#Copy & {
			contents: client.filesystem."./frontend".read.contents
			dest:     "/app"
		},
		bash.#Run & {
			workdir: "/app"
			mounts:  _frontendModulesMount
			script: contents: "yarn"
		},
	]
}
```

## ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
`dagger.#Plan: actions: codecheck:`ã«ã¦CodeCheckã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚
ã“ã“ã§ã€backendã¨frontendã®é–“ã«å‚ç…§ãŒå­˜åœ¨ã—ãªã„(=ä¾å­˜é–¢ä¿‚ãŒãªã„)ãŸã‚ã€ã“ã®2ã¤ã¯ä¸¦åˆ—å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
åŒæ§˜ã« `typeCheck / lint / format`ã®é–“ã«ã‚‚å‚ç…§ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€ã™ã¹ã¦ä¸¦åˆ—å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```go:codecheck.cue
codecheck: {
	backend: {
		typeCheck: bash.#Run & {
			input:   backendDeps.output
			workdir: "/app"
			mounts:  _backendModulesMount
			script: contents: "yarn type-check"
		}
		lint: bash.#Run & {
			input:   backendDeps.output
			workdir: "/app"
			mounts:  _backendModulesMount
			script: contents: "yarn lint"
		}
		format: bash.#Run & {
			input:   backendDeps.output
			workdir: "/app"
			mounts:  _backendModulesMount
			script: contents: "yarn format"
		}
	}
	frontend: {
		typeCheck: bash.#Run & {
			input:   frontendDeps.output
			workdir: "/app"
			mounts:  _frontendModulesMount
			script: contents: "yarn type-check"
		}
		lint: bash.#Run & {
			input:   frontendDeps.output
			workdir: "/app"
			mounts:  _frontendModulesMount
			script: contents: "yarn lint"
		}
		format: bash.#Run & {
			input:   frontendDeps.output
			workdir: "/app"
			mounts:  _frontendModulesMount
			script: contents: "yarn format"
		}
	}
}
```

# å®Ÿéš›ã«ä½¿ã£ã¦ã¿ãŸ
ã“ã‚Œã§ãƒ­ãƒ¼ã‚«ãƒ«ã§ã¯å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
```
$ dagger do --log-format=plain -p './dagger' codecheck
```

ãŸã ã€å®Ÿç”¨æ€§ã‚’è€ƒãˆã‚‹ã¨Github Actionsä¸Šã§å‹•ä½œã•ã›ã¦PRãƒãƒ¼ã‚¸å‰ã«è‡ªå‹•ã§ç¢ºèªã—ãŸã„ã§ã™ã­ã€‚
ãã“ã§ã€å®Ÿè£…ã—ãŸãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```yaml:.github/workflows/codecheck.yml
name: codecheck

on:
  push:
    branches:
      - master
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

jobs:
  dagger:
    runs-on: ubuntu-latest
    steps:
      - name: Clone repository
        uses: actions/checkout@v2

      - name: Code Check
        uses: dagger/dagger-for-github@v3
        with:
          version: 0.2
          cmds: |
            project update
            do --log-format=plain -p ./dagger codecheck
```

CodeCheckç¨‹åº¦ã§ã‚ã‚Œã°ãŠãã‚‰ãç›´æ¥Github Actionsã«å®Ÿè£…ã—ã¦ã‚‚ã•ã»ã©å¤‰ã‚ã‚‰ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚
ã—ã‹ã—ãªãŒã‚‰ã€ä»Šå¾Œãƒ‡ãƒ—ãƒ­ã‚¤ã®è‡ªå‹•åŒ–ãªã©ã€ã‚ˆã‚Šè¤‡é›‘ãªã“ã¨ã‚’ã—ãŸããªã£ãŸã¨ãã§ã‚‚åŒã˜ã‚ˆã†ãªYAMLã‚’ä½œæˆã™ã‚‹ã ã‘ã§ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®è¨­å®šã‚’Daggerã§éš è”½ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

PRã‚’ä½œæˆã™ã‚‹ã¨ã€è‡ªå‹•ã§CodeCheckãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚ã†ã‚Œã—ã„ã€‚
![](https://storage.googleapis.com/zenn-user-upload/6262acc50d59-20220514.png)

# ãŠã‚ã‚Šã«
ä»Šå›ã¯Github Actionsä¸Šã§å®Ÿè¡Œã™ã‚‹CodeCheckã‚’Daggerã‚’ç”¨ã„ã¦å®Ÿè£…ã—ã¦ã¿ã¾ã—ãŸã€‚
ä»–ã®CIãƒ„ãƒ¼ãƒ«ä¸Šã§å‹•ä½œã•ã›ã‚‹éš›ã‚‚ã€€`.github/workflows/codecheck.yml` ã«ã‚ãŸã‚‹ã€CIãƒ„ãƒ¼ãƒ«å›ºæœ‰ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å·®ã—æ›¿ãˆã‚‹ã ã‘ã§å®Ÿè¡Œã§ãã¾ã™ã€‚ã™ã”ã„ã§ã™ã­ã€‚
https://docs.dagger.io/1201/ci-environment

ä»Šå›å®Ÿè£…ã—ãŸãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å•é¡Œç‚¹ã¨ã—ã¦ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã™ã‚‹éš›ã¯ä¾å­˜é–¢ä¿‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒåŠ¹ãã®ã§é€Ÿã„ã®ã§ã™ãŒã€Github Actionsä¸Šã§ã¯æ¯å› `yarn install` ã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒèµ°ã£ã¦ã„ã‚‹ã®ã§æ­£ç›´é…ã„ã§ã™ã€‚
ã©ã†ã«ã‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åŠ¹ã‹ã›ã‚‰ã‚Œãªã„ã‹ã¨è€ƒãˆãªãŒã‚‰ã“ã®è¨˜äº‹ã‚’æ›¸ã„ã¦ã„ãŸã¨ã“ã‚ã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã€ŒPersistent cache in GitHub Actionsã€ã¨ã„ã†ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚
https://docs.dagger.io/1237/persistent-cache-with-dagger#persistent-cache-in-github-actions

æ¬¡ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ãƒ•ãƒ«æ´»ç”¨ã—ã¦é«˜é€ŸåŒ–ã§ããªã„ã‹æ¤œè¨¼ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚
